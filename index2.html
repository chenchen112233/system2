<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾å®¹çš®è†šç®¡ç†é¡§å®¢ç³»çµ± - Firebase ç‰ˆ</title>
    <style>
        /* ä¿ç•™æ‚¨åŸæœ¬çš„æ‰€æœ‰ CSS æ¨£å¼ */
        :root {
            --bg-color: #F7F4EF;
            --card-bg: #FFFFFF;
            --text-main: #5D4037;
            --text-light: #8D6E63;
            --accent-color: #D7CCC8;
            --primary-btn: #8D6E63;
            --btn-text: #FFFFFF;
            --danger-color: #e57373;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: "PingFang TC", "Noto Sans TC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; 
        }

        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            background: var(--bg-color);
            transition: transform 0.3s ease;
            overflow-y: auto; padding: 20px;
        }

        .view.hidden { transform: translateX(100%); display: none; }
        
        h2 { font-size: 22px; margin: 10px 0 20px 0; color: var(--text-main); text-align: center; }
        h3 { font-size: 16px; margin: 25px 0 10px 0; border-left: 4px solid var(--text-light); padding-left: 10px; color: var(--text-main); }
        
        .search-box { position: sticky; top: 0; z-index: 10; background: var(--bg-color); padding-bottom: 10px; }
        .search-input {
            width: 100%; padding: 15px; border: none; border-radius: 50px;
            background: #FFF; box-shadow: 0 4px 15px rgba(93, 64, 55, 0.08);
            font-size: 16px; color: var(--text-main); outline: none; text-align: center;
        }

        .customer-list { margin-top: 10px; padding-bottom: 80px; }
        .customer-card {
            background: #FFF; border-radius: 16px; padding: 15px 20px; margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: transform 0.1s;
        }
        .customer-card:active { transform: scale(0.98); }
        .c-name { font-size: 18px; font-weight: bold; }
        .c-phone { font-size: 14px; color: var(--text-light); }
        
        .fab-btn {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--primary-btn); color: white; padding: 15px 30px; border-radius: 50px;
            font-size: 16px; font-weight: bold; box-shadow: 0 5px 20px rgba(141, 110, 99, 0.4);
            border: none; cursor: pointer; z-index: 100; display: flex; align-items: center; gap: 8px;
        }

        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn, .save-btn, .delete-btn { background: none; border: none; color: var(--text-light); font-size: 16px; cursor: pointer; padding: 10px; }
        .save-btn { color: var(--primary-btn); font-weight: bold; }
        .delete-btn { color: var(--danger-color); font-size: 14px; display: none; } /* é è¨­éš±è—ï¼Œç·¨è¼¯æ™‚æ‰é¡¯ç¤º */

        .form-section { background: #FFF; padding: 20px; border-radius: 16px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; color: var(--text-light); margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="date"], input[type="tel"], input[type="number"] {
            width: 100%; padding: 8px 0; border: none; border-bottom: 1px solid #D7CCC8;
            background: transparent; font-size: 16px; outline: none; border-radius: 0; color: var(--text-main);
        }
        
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .checkbox-item { display: flex; align-items: center; font-size: 15px; cursor: pointer; min-height: 25px; }
        .checkbox-item input { margin-right: 8px; accent-color: var(--text-light); width: 18px; height: 18px; }

        .record-item { border-left: 3px solid var(--accent-color); padding-left: 15px; margin-bottom: 20px; position: relative; }
        .record-title { font-size: 16px; font-weight: bold; color: var(--text-main); }
        .record-date { font-size: 12px; color: var(--text-light); margin-top: 2px;}
        .record-content { font-size: 14px; margin: 4px 0; font-weight: 500; color: #555; }
        .record-meta { font-size: 13px; color: #888; }
        .delete-record { position: absolute; right: 0; top: 0; color: #ff6b6b; font-size: 12px; cursor: pointer; padding: 5px; }

        .tabs { display: flex; background: #EFEBE9; padding: 4px; border-radius: 30px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-light); border-radius: 25px; transition: 0.3s; font-weight: bold; }
        .tab-btn.active { background: #FFF; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-content { display: none; padding-bottom: 50px; }
        .tab-content.active { display: block; }

        .consent-box {
            background-color: #FAFAFA;
            border: 1px dashed #D7CCC8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            font-size: 12px;
            line-height: 1.6;
            color: #5D4037;
        }
        .consent-box ol { padding-left: 20px; margin: 0; }
        .consent-box li { margin-bottom: 5px; }

        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 8px; display: none; z-index: 200;
        }
    </style>
</head>
<body>

<div id="home-view" class="view">
    <div style="text-align:center; padding: 20px 0;">
        <div style="font-size:14px; color:var(--text-light); letter-spacing: 2px;">BEAUTY STUDIO</div>
        <h2>é¡§å®¢è³‡æ–™ç®¡ç†</h2>
    </div>
    <div class="search-box">
        <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹é¡§å®¢å§“å..." oninput="renderList()">
    </div>
    <div id="customerList" class="customer-list"></div>
    <button class="fab-btn" onclick="openEditor()">
        <span>ï¼‹ å»ºç«‹æ–°é¡§å®¢è³‡æ–™</span>
    </button>
</div>

<div id="editor-view" class="view hidden">
    <div class="top-nav">
        <button class="back-btn" onclick="goHome()">âœ• å–æ¶ˆ</button>
        <button id="deleteBtn" class="delete-btn" onclick="deleteCustomer()">ğŸ—‘ï¸ åˆªé™¤</button>
        <button class="save-btn" onclick="saveCustomer()">âœ“ å„²å­˜</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab-info')">æ­£é¢ï¼šé¢è¨ºè³‡æ–™</button>
        <button class="tab-btn" onclick="switchTab('tab-record')">èƒŒé¢ï¼šèª²ç¨‹ç´€éŒ„</button>
    </div>

    <div id="tab-info" class="tab-content active">
        <div class="form-section">
            <h3>åŸºæœ¬è³‡æ–™</h3>
            <div class="form-group"><label>è«®è©¢æ—¥æœŸ DATE</label><input type="date" id="consultDate"></div>
            <div class="form-group"><label>è«®è©¢å¸« COUNSELOR</label><input type="text" id="counselor"></div>
            <div class="form-group"><label>å§“å NAME</label><input type="text" id="custName" placeholder="å¿…å¡«"></div>
            <div class="form-group">
                <label>æ€§åˆ¥ GENDER</label>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="radio" name="gender" value="ç”·"> ç”·</label>
                    <label class="checkbox-item"><input type="radio" name="gender" value="å¥³"> å¥³</label>
                    <label class="checkbox-item"><input type="radio" name="gender" value="å…¶ä»–"> å…¶ä»–</label>
                </div>
            </div>
            <div class="form-group"><label>ç”Ÿæ—¥ BIRTHDAY</label><input type="date" id="birthday"></div>
            <div class="form-group"><label>é›»è©± TEL</label><input type="tel" id="tel"></div>
        </div>
        <div class="form-section">
            <h3>çš®è†šç‹€æ³ SKIN PROPERTIES</h3>
            <div class="form-group"><label>çš®è†šæ€§è³ª</label>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="radio" name="skinType" value="ä¹¾æ€§"> ä¹¾æ€§</label>
                    <label class="checkbox-item"><input type="radio" name="skinType" value="æ²¹æ€§"> æ²¹æ€§</label>
                    <label class="checkbox-item"><input type="radio" name="skinType" value="æ··åˆæ€§"> æ··åˆæ€§</label>
                    <label class="checkbox-item"><input type="radio" name="skinType" value="æ•æ„Ÿæ€§"> æ•æ„Ÿæ€§</label>
                    <label class="checkbox-item"><input type="radio" name="skinType" value="ä¸­æ€§"> ä¸­æ€§</label>
                </div>
            </div>
            <div class="form-group"><label>è—¥ç‰©éæ•å²</label>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="radio" name="drugAllergy" value="æœ‰"> æœ‰</label>
                    <label class="checkbox-item"><input type="radio" name="drugAllergy" value="ç„¡"> ç„¡</label>
                </div>
            </div>
            <div class="form-group"><label>éæ•åŸ ALLERGENS</label><input type="text" id="allergens"></div>
        </div>
        <div class="form-section">
            <h3>æœ€æƒ³æ”¹å–„çš„å•é¡Œ IMPROVING ISSUES</h3>
            <div class="checkbox-group" style="flex-direction: column;">
                <label class="checkbox-item"><input type="checkbox" class="issue-cb" value="çš®è†šå‡ºæ²¹ã€æ¯›å­”ç²—å¤§"> çš®è†šå‡ºæ²¹ã€æ¯›å­”ç²—å¤§</label>
                <label class="checkbox-item"><input type="checkbox" class="issue-cb" value="æš—é»ƒã€è†šè‰²ä¸å‡"> æš—é»ƒã€è†šè‰²ä¸å‡</label>
                <label class="checkbox-item"><input type="checkbox" class="issue-cb" value="çš®è†šä¹¾ç‡¥ç¼ºæ°´"> çš®è†šä¹¾ç‡¥ç¼ºæ°´</label>
                <label class="checkbox-item"><input type="checkbox" class="issue-cb" value="ç²‰åˆºç—˜ç—˜"> ç²‰åˆºç—˜ç—˜</label>
                <label class="checkbox-item"><input type="checkbox" class="issue-cb" value="é¬†å¼›ã€æå‡ç·Šç·»"> é¬†å¼›ã€æå‡ç·Šç·»</label>
                <label class="checkbox-item"><input type="checkbox" class="issue-cb" value="æ–‘é»ã€é›€æ–‘ã€è‰²ç´ "> æ–‘é»ã€é›€æ–‘ã€è‰²ç´ </label>
                <label class="checkbox-item"><input type="checkbox" class="issue-cb" value="é¢éƒ¨æ³›ç´…è¡€çµ²ã€æ•æ„Ÿ"> é¢éƒ¨æ³›ç´…è¡€çµ²ã€æ•æ„Ÿ</label>
            </div>
        </div>
        <div class="form-section">
            <h3>å¤šä¹…åšä¸€æ¬¡é¢éƒ¨è­·ç† HOW LONG</h3>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="radio" name="howLong" value="å …æŒå®šæœŸ"> å …æŒå®šæœŸ</label>
                <label class="checkbox-item"><input type="radio" name="howLong" value="ä¸ç¶“å¸¸"> ä¸ç¶“å¸¸</label>
                <label class="checkbox-item"><input type="radio" name="howLong" value="å¶çˆ¾"> å¶çˆ¾</label>
                <label class="checkbox-item"><input type="radio" name="howLong" value="æœªæ›¾"> æœªæ›¾</label>
            </div>
        </div>
        <div class="form-section">
            <h3>ä»¥å‰åšéå“ªäº›çš®è†šç®¡ç†</h3>
            <div class="checkbox-group" style="flex-direction: column;">
                <label class="checkbox-item"><input type="checkbox" class="history-cb" value="ç”Ÿæ´»ç¾å®¹"> ç”Ÿæ´»ç¾å®¹</label>
                <label class="checkbox-item"><input type="checkbox" class="history-cb" value="å„€å™¨å°å…¥"> å„€å™¨å°å…¥</label>
                <label class="checkbox-item"><input type="checkbox" class="history-cb" value="å±…å®¶ç”¢å“"> å±…å®¶ç”¢å“</label>
                <label class="checkbox-item"><input type="checkbox" class="history-cb" value="å…‰é›»å„€å™¨"> å…‰é›»å„€å™¨</label>
                <div style="display:flex; align-items:center; width:100%;">
                    <input type="checkbox" class="history-cb" value="å…¶ä»–" id="historyOtherCheck"> 
                    <span style="margin-left:5px;">å…¶ä»–ï¼š</span>
                    <input type="text" id="historyOtherText" style="flex:1;">
                </div>
            </div>
        </div>
        <div class="form-section">
            <h3>èº«é«”ç‹€æ³ PHYSICAL CONDITION</h3>
            <div class="form-group">
                <label>ç¡çœ ï¼š</label>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="radio" name="sleep" value="æ­£å¸¸"> æ­£å¸¸</label>
                    <label class="checkbox-item"><input type="radio" name="sleep" value="æœ‰æ™‚ç†¬å¤œ"> æœ‰æ™‚ç†¬å¤œ</label>
                    <label class="checkbox-item"><input type="radio" name="sleep" value="ç¶“å¸¸ç†¬å¤œ"> ç¶“å¸¸ç†¬å¤œ</label>
                </div>
            </div>
            <div class="form-group">
                <label>é£²é£Ÿï¼š</label>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" class="diet-cb" value="ç‡Ÿé¤Šå‡è¡¡"> ç‡Ÿé¤Šå‡è¡¡</label>
                    <label class="checkbox-item"><input type="checkbox" class="diet-cb" value="é£²é…’"> é£²é…’</label>
                    <label class="checkbox-item"><input type="checkbox" class="diet-cb" value="è¾›è¾£"> è¾›è¾£</label>
                    <label class="checkbox-item"><input type="checkbox" class="diet-cb" value="æ²¹è†©"> æ²¹è†©</label>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-record" class="tab-content">
        <div class="form-section">
            <h3>æ–°å¢èª²ç¨‹ç´€éŒ„</h3>
            <div class="form-group"><label>èª²ç¨‹åç¨±</label><input type="text" id="recTitle"></div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="recDate"></div>
            <div class="form-group"><label>å…§å®¹</label><input type="text" id="recContent"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1;"><label>é‡‘é¡</label><input type="number" id="recAmount"></div>
                <div class="form-group" style="flex:1;"><label>æ“ä½œå“¡</label><input type="text" id="recOperator"></div>
            </div>
            <button onclick="addRecordItem()" style="width:100%; padding:12px; background:#EFEBE9; border:none; border-radius:8px; color:#5D4037; font-weight:bold;">ï¼‹ åŠ å…¥æ­¤ç­†ç´€éŒ„</button>
        </div>
        <div id="recordsContainer"></div>
    </div>
</div>

<div id="toast" class="toast">æˆåŠŸ</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
       apiKey: "AIzaSyB6vCrIFhyvmjFEnmt1ByG5rjGnwa7zEZM",
    authDomain: "system2-ae1a4.firebaseapp.com",
    databaseURL: "https://system2-ae1a4-default-rtdb.firebaseio.com", 
    projectId: "system2-ae1a4",
    storageBucket: "system2-ae1a4.firebasestorage.app",
    messagingSenderId: "767435545763",
    appId: "1:767435545763:web:ffbbe0f3adc42541ebb316",
    measurementId: "G-9MER3T7NGE"
  };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'customers');

    let customers = {}; 
    let currentId = null;

    window.goHome = function() {
        document.getElementById('home-view').style.display = 'flex';
        document.getElementById('editor-view').classList.add('hidden');
        setTimeout(() => document.getElementById('editor-view').style.display = 'none', 300);
    };

    window.openEditor = function(id = null) {
        currentId = id;
        document.getElementById('home-view').style.display = 'none';
        const editor = document.getElementById('editor-view');
        editor.style.display = 'flex';
        setTimeout(() => editor.classList.remove('hidden'), 10);
        
        // å¦‚æœæ˜¯èˆŠè³‡æ–™ï¼Œé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
        document.getElementById('deleteBtn').style.display = id ? 'block' : 'none';
        
        clearForm();
        if (id && customers[id]) loadDataToForm(customers[id]);
    };

    // æ–°å¢åˆªé™¤å‡½å¼
    window.deleteCustomer = function() {
        if (!currentId) return;
        if (confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ä½é¡§å®¢çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) {
            remove(ref(db, 'customers/' + currentId))
                .then(() => {
                    showToast('å·²åˆªé™¤');
                    goHome();
                })
                .catch(err => alert("åˆªé™¤å¤±æ•—: " + err.message));
        }
    };

    window.saveCustomer = function() {
        const name = document.getElementById('custName').value.trim();
        if (!name) { alert('è«‹å¡«å¯«å§“å'); return; }

        const data = {
            updatedAt: Date.now(),
            name: name,
            consultDate: document.getElementById('consultDate').value,
            counselor: document.getElementById('counselor').value,
            gender: getRadio('gender'),
            birthday: document.getElementById('birthday').value,
            tel: document.getElementById('tel').value,
            skinType: getRadio('skinType'),
            drugAllergy: getRadio('drugAllergy'),
            allergens: document.getElementById('allergens').value,
            howLong: getRadio('howLong'),
            sleep: getRadio('sleep'),
            historyOtherText: document.getElementById('historyOtherText').value,
            issues: getCheckboxes('.issue-cb'),
            history: getCheckboxes('.history-cb'),
            diet: getCheckboxes('.diet-cb'),
            records: getRecordsFromUI()
        };

        const targetRef = currentId ? ref(db, 'customers/' + currentId) : push(dbRef);
        
        (currentId ? update(targetRef, data) : set(targetRef, data))
            .then(() => {
                showToast(currentId ? 'æ›´æ–°æˆåŠŸ' : 'å„²å­˜æˆåŠŸ');
                goHome();
            })
            .catch(err => alert("å„²å­˜å¤±æ•—: " + err.message));
    };

    window.renderList = function() {
        const query = document.getElementById('searchInput').value.trim();
        const container = document.getElementById('customerList');
        container.innerHTML = '';
        let list = Object.keys(customers).map(key => ({...customers[key], id: key}));
        const filtered = list.filter(c => c.name.includes(query));
        filtered.sort((a, b) => b.updatedAt - a.updatedAt);
        filtered.forEach(c => {
            const div = document.createElement('div');
            div.className = 'customer-card';
            div.innerHTML = `<div><div class="c-name">${c.name}</div><div class="c-phone">${c.tel || 'ç„¡é›»è©±'}</div></div><div>â€º</div>`;
            div.onclick = () => openEditor(c.id);
            container.appendChild(div);
        });
    };

    // å…¶ä»–è¼”åŠ©å‡½å¼ä¿æŒä¸è®Š...
    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if(tabId === 'tab-info') document.querySelectorAll('.tab-btn')[0].classList.add('active');
        else document.querySelectorAll('.tab-btn')[1].classList.add('active');
        document.getElementById(tabId).classList.add('active');
    };
    function getRadio(n){ return document.querySelector(`input[name="${n}"]:checked`)?.value || ""; }
    function getCheckboxes(s){ return Array.from(document.querySelectorAll(s+':checked')).map(cb=>cb.value); }
    function getRecordsFromUI(){
        return Array.from(document.querySelectorAll('.record-item')).map(i=>({
            title: i.dataset.title, date: i.dataset.date, content: i.dataset.content, amount: i.dataset.amount, operator: i.dataset.operator
        }));
    }
    function clearForm(){
        document.querySelectorAll('input').forEach(i=>{ if(i.type==='radio'||i.type==='checkbox')i.checked=false; else if(i.id!=='recDate')i.value=''; });
        document.getElementById('recordsContainer').innerHTML = '';
        document.getElementById('recDate').value = new Date().toISOString().split('T')[0];
    }
    function loadDataToForm(d){
        document.getElementById('consultDate').value = d.consultDate||'';
        document.getElementById('custName').value = d.name||'';
        document.getElementById('tel').value = d.tel||'';
        ['gender','skinType','drugAllergy','howLong','sleep'].forEach(n=>{
            const el = document.querySelector(`input[name="${n}"][value="${d[n]}"]`);
            if(el) el.checked = true;
        });
        const cbLoad = (s, v) => { if(v) document.querySelectorAll(s).forEach(cb=>{ if(v.includes(cb.value)) cb.checked=true; }); };
        cbLoad('.issue-cb', d.issues); cbLoad('.history-cb', d.history); cbLoad('.diet-cb', d.diet);
        if(d.records) d.records.forEach(r => renderRecordItem(r));
    }
    window.addRecordItem = function(){
        const r = { title: document.getElementById('recTitle').value, date: document.getElementById('recDate').value, content: document.getElementById('recContent').value, amount: document.getElementById('recAmount').value, operator: document.getElementById('recOperator').value };
        renderRecordItem(r, true);
    };
    function renderRecordItem(r, isNew=false){
        const div = document.createElement('div');
        div.className = 'record-item';
        div.dataset.title=r.title; div.dataset.date=r.date; div.dataset.content=r.content; div.dataset.amount=r.amount; div.dataset.operator=r.operator;
        div.innerHTML = `<div class="delete-record" onclick="this.parentElement.remove()">âœ•</div><div class="record-title">${r.title}</div><div class="record-date">${r.date}</div><div class="record-content">${r.content}</div>`;
        const c = document.getElementById('recordsContainer');
        if(isNew) c.prepend(div); else c.appendChild(div);
    }
    function showToast(m){ const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }

    onValue(dbRef, (snap) => { customers = snap.val() || {}; renderList(); });
</script>
</body>
</html>
